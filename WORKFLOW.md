# ğŸ¥ SpinoCare Application Workflow

## Table of Contents
- [Overview](#overview)
- [Application Architecture](#application-architecture)
- [User Workflows](#user-workflows)
- [Technical Workflows](#technical-workflows)
- [Data Flow](#data-flow)
- [Model Management](#model-management)
- [Error Handling](#error-handling)

---

## Overview

**SpinoCare** is an AI-powered mobile application for detecting Modic changes in spinal MRI scans. It uses TensorFlow Lite for local inference and a FastAPI backend for federated learning and cloud inference.

### Key Features
- ğŸ§  **Dual Inference Modes**: Online (server) and Offline (local)
- ğŸ”„ **Automatic Model Updates**: Background updates every 6 hours
- ğŸ“± **Offline-First**: Works without internet using bundled/downloaded models
- ğŸ” **Privacy-Focused**: Local inference keeps MRI images on device
- ğŸ¨ **Image Processing**: Built-in cropping with UCrop library

---

## Application Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SpinoCare Mobile App                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ UI Layer     â”‚  â”‚ Analysis     â”‚  â”‚ Model Mgmt   â”‚      â”‚
â”‚  â”‚ (Compose)    â”‚  â”‚ Engine       â”‚  â”‚ (Auto-update)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                                     â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Local Model  â”‚                    â”‚ Remote Model â”‚       â”‚
â”‚  â”‚ (TFLite)     â”‚                    â”‚ (FastAPI)    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                     â”‚
          â”‚                                     â–¼
          â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                            â”‚ Backend Server  â”‚
          â”‚                            â”‚ modic.onrender  â”‚
          â”‚                            â”‚ .com            â”‚
          â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    (Model Download)
```

### Components

#### **Frontend (Kotlin/Jetpack Compose)**
- `SimpleMainActivity` - Main screen with image selection and analysis
- `ModelSettingsActivity` - Settings for model management
- `ModicAnalyzer` - Unified analyzer interface
- `LocalModelAnalyzer` - TFLite offline inference
- `RemoteModelAnalyzer` - Server-based inference
- `ModelUpdateManager` - Automatic update handling

#### **Backend (Python/FastAPI)** - Located in `backend-deploy/python-ml-server/`
- `main.py` - FastAPI server with endpoints
- `modic_model.tflite` - Global TFLite model
- Federated learning aggregation
- Model versioning and distribution

#### **Backend (PHP REST API)** - Located in `backend-deploy/php-api/`
- `auth.php` - User authentication with OTP email verification
- `email.php` - PHPMailer integration for OTP emails
- `users.php` - User management endpoints
- `analysis.php` - MRI analysis data storage
- `config.php` - Database configuration
- MySQL database schema in `backend-deploy/database/`

---

## User Workflows

### 1. **First Time Setup**

```
User launches app
    â†“
[Splash Screen / Onboarding]
    â†“
Check for bundled model in assets/
    â”œâ”€ Found: âœ… Ready for offline analysis
    â””â”€ Not found: ğŸŒ Online mode only (until download)
    â†“
Initialize auto-update system
    â”œâ”€ Check network availability
    â”œâ”€ Call /model_info endpoint
    â””â”€ Download model if available
    â†“
[Main Screen - Ready to analyze]
```

### 2. **MRI Image Analysis Workflow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Select T1-weighted MRI Image               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ User taps "Select T1 Image"                 â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Open image picker (Gallery/Camera)          â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ [Optional] Crop image with UCrop            â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Display preview                             â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Select T2-weighted MRI Image               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ User taps "Select T2 Image"                 â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Open image picker (Gallery/Camera)          â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ [Optional] Crop image with UCrop            â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Display preview                             â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Analyze                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ User taps "Analyze Images"                  â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Check analysis mode                         â”‚    â”‚
â”‚ â”‚   â”œâ”€ Offline Mode + Model Available         â”‚    â”‚
â”‚ â”‚   â”‚   â†’ Local TFLite Inference              â”‚    â”‚
â”‚ â”‚   â”‚                                         â”‚    â”‚
â”‚ â”‚   â””â”€ Online Mode / No Local Model           â”‚    â”‚
â”‚ â”‚       â†’ Server Inference (FastAPI)          â”‚    â”‚
â”‚ â”‚   â†“                                         â”‚    â”‚
â”‚ â”‚ Show loading indicator                      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: View Results                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Display Result Card:                        â”‚    â”‚
â”‚ â”‚   â€¢ Label: "Modic Change Detected" or       â”‚    â”‚
â”‚ â”‚            "No Modic Changes"               â”‚    â”‚
â”‚ â”‚   â€¢ Confidence: XX.XX%                      â”‚    â”‚
â”‚ â”‚   â€¢ Color-coded indicator                   â”‚    â”‚
â”‚ â”‚   â€¢ Analysis mode badge (ğŸŒ/ğŸ“±)             â”‚    â”‚
â”‚ â”‚                                             â”‚    â”‚
â”‚ â”‚ Options:                                    â”‚    â”‚
â”‚ â”‚   [Analyze Another] [Share Results]         â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **Model Settings Workflow**

```
User taps Settings icon
    â†“
[Model Settings Screen]
    â”‚
    â”œâ”€ Server Connectivity
    â”‚   â””â”€ "Test Connection" â†’ Ping server â†’ Show status
    â”‚
    â”œâ”€ Local Model Status
    â”‚   â”œâ”€ Green: Model available âœ…
    â”‚   â”œâ”€ Yellow: Waiting for download âš ï¸
    â”‚   â””â”€ Actions:
    â”‚       â””â”€ "Check for Updates Now" â†’ Manual update check
    â”‚
    â””â”€ Analysis Mode
        â”œâ”€ Offline Mode Toggle
        â”‚   â””â”€ ON: Use local TFLite
        â”‚   â””â”€ OFF: Use server inference
        â”‚
        â””â”€ Auto Update Toggle
            â””â”€ ON: Background updates every 6 hours
            â””â”€ OFF: Manual updates only
```

### 4. **Image Cropping Workflow (UCrop)**

```
User selects image from gallery
    â†“
UCrop Activity launches
    â”‚
    â”œâ”€ Red/Pink theme matching app
    â”œâ”€ Gesture controls:
    â”‚   â€¢ Pinch to zoom
    â”‚   â€¢ Drag to pan
    â”‚   â€¢ Rotation slider
    â”‚   â€¢ Aspect ratio lock
    â”‚
    â””â”€ Actions:
        â”œâ”€ âœ“ (Checkmark) â†’ Confirm crop â†’ Return to main screen
        â””â”€ âœ— (Cancel) â†’ Discard â†’ Back to image selection
```

---

## Technical Workflows

### 1. **Local Inference Workflow (Offline Mode)**

```kotlin
// Step-by-step process
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User Analysis Request                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ModicAnalyzer.analyze(t1Image, t2Image)              â”‚
â”‚    â€¢ Check mode: isOfflineModeEnabled() = true          â”‚
â”‚    â€¢ Check availability: isLocalModelAvailable() = true â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. LocalModelAnalyzer.analyze()                         â”‚
â”‚    â€¢ Initialize interpreter if needed                    â”‚
â”‚    â€¢ Load model from:                                   â”‚
â”‚      1. assets/modic_model.tflite (bundled)            â”‚
â”‚      2. files/modic_model_offline.tflite (downloaded)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Image Preprocessing                                   â”‚
â”‚    For each image (T1 and T2):                          â”‚
â”‚    â€¢ Resize to 224Ã—224                                  â”‚
â”‚    â€¢ Extract RGB pixels                                 â”‚
â”‚    â€¢ Normalize: (pixel - 127.5) / 127.5                â”‚
â”‚    â€¢ Pack into ByteBuffer (LITTLE_ENDIAN)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TFLite Inference                                      â”‚
â”‚    â€¢ Input: [t1Buffer, t2Buffer]                        â”‚
â”‚    â€¢ Model: Dual-input CNN                              â”‚
â”‚    â€¢ Output: [noModicScore, modicScore]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Result Processing                                     â”‚
â”‚    â€¢ Compare scores                                      â”‚
â”‚    â€¢ Determine label:                                   â”‚
â”‚      if modicScore > noModicScore:                      â”‚
â”‚         "Modic Change Detected"                         â”‚
â”‚      else:                                              â”‚
â”‚         "No Modic Changes"                              â”‚
â”‚    â€¢ Extract confidence (higher score)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Display Result                                        â”‚
â”‚    AnalysisResult(                                       â”‚
â”‚      label = "No Modic Changes",                        â”‚
â”‚      confidence = 0.9969,                               â”‚
â”‚      mode = "offline"                                    â”‚
â”‚    )                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Online Inference Workflow (Server Mode)**

```kotlin
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User Analysis Request                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ModicAnalyzer.analyze(t1Image, t2Image)              â”‚
â”‚    â€¢ Check mode: isOfflineModeEnabled() = false         â”‚
â”‚    â€¢ Route to RemoteModelAnalyzer                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. RemoteModelAnalyzer.analyze()                        â”‚
â”‚    â€¢ Convert bitmaps to ByteArrays (PNG)                â”‚
â”‚    â€¢ Encode as Base64                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. HTTP Request to Server                                â”‚
â”‚    POST https://modic.onrender.com/predict              â”‚
â”‚    {                                                     â”‚
â”‚      "t1_image": "base64_encoded_data...",              â”‚
â”‚      "t2_image": "base64_encoded_data..."               â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Server Processing (FastAPI Backend)                  â”‚
â”‚    â€¢ Decode Base64 images                               â”‚
â”‚    â€¢ Preprocess (resize, normalize)                     â”‚
â”‚    â€¢ Run TFLite inference                               â”‚
â”‚    â€¢ Calculate scores                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Server Response                                       â”‚
â”‚    {                                                     â”‚
â”‚      "label": "No Modic",                               â”‚
â”‚      "confidence": 0.9999996,                           â”‚
â”‚      "detailed_scores": {                               â”‚
â”‚        "no_modic": 0.9999996,                           â”‚
â”‚        "modic": 0.0000004                               â”‚
â”‚      }                                                   â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Parse Response                                        â”‚
â”‚    â€¢ Fix label parsing (check for "No")                 â”‚
â”‚    â€¢ Use detailed_scores if available                   â”‚
â”‚    â€¢ Create AnalysisResult                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Display Result                                        â”‚
â”‚    AnalysisResult(                                       â”‚
â”‚      label = "No Modic Changes",                        â”‚
â”‚      confidence = 0.9999,                               â”‚
â”‚      mode = "online"                                     â”‚
â”‚    )                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **Automatic Model Update Workflow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Launch                                                 â”‚
â”‚ SimpleMainActivity.onCreate()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initialize Auto-Updates                                    â”‚
â”‚ modicAnalyzer.initializeAutoUpdates()                     â”‚
â”‚   â€¢ Start periodic check (every 6 hours)                  â”‚
â”‚   â€¢ Set up ModelUpdateManager                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background Coroutine (Infinite Loop)                       â”‚
â”‚ while(isActive) {                                         â”‚
â”‚   if (6 hours passed && network available) {              â”‚
â”‚     checkForUpdates()                                     â”‚
â”‚   }                                                        â”‚
â”‚   delay(CHECK_INTERVAL_MS)                                â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for Updates                                          â”‚
â”‚ Step 1: Call GET /model_info                              â”‚
â”‚ Response: {                                                â”‚
â”‚   "model_hash": "a1b2c3...",                              â”‚
â”‚   "model_version": "42",                                   â”‚
â”‚   "model_size_mb": 8.36                                   â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Compare Hashes                                     â”‚
â”‚ serverHash = "a1b2c3..."                                  â”‚
â”‚ localHash = calculateFileHash(local_model)                â”‚
â”‚                                                            â”‚
â”‚ if (serverHash != localHash):                             â”‚
â”‚   â†’ UPDATE NEEDED                                         â”‚
â”‚ else:                                                      â”‚
â”‚   â†’ Already up to date                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Download Model (if update needed)                 â”‚
â”‚ â€¢ Call GET /get_global_model                              â”‚
â”‚ â€¢ Stream to temp file                                     â”‚
â”‚ â€¢ Track progress (onDownloadProgress)                     â”‚
â”‚ â€¢ Save as: modic_model_offline.tflite.tmp                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Verify Download                                    â”‚
â”‚ downloadedHash = calculateFileHash(temp_file)             â”‚
â”‚                                                            â”‚
â”‚ if (downloadedHash == serverHash):                        â”‚
â”‚   â†’ VERIFICATION SUCCESS                                  â”‚
â”‚   â€¢ Delete old model                                      â”‚
â”‚   â€¢ Rename temp â†’ modic_model_offline.tflite             â”‚
â”‚   â€¢ Update SharedPreferences                              â”‚
â”‚   â€¢ Trigger callback: onDownloadCompleted(true)           â”‚
â”‚ else:                                                      â”‚
â”‚   â†’ VERIFICATION FAILED                                   â”‚
â”‚   â€¢ Delete temp file                                      â”‚
â”‚   â€¢ Keep old model                                        â”‚
â”‚   â€¢ Trigger callback: onUpdateError()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Update Complete                                    â”‚
â”‚ â€¢ Log: "âœ… Model updated to version 42"                   â”‚
â”‚ â€¢ Update last_check_time in SharedPreferences             â”‚
â”‚ â€¢ Next check in 6 hours                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### 1. **Image Data Flow**

```
Gallery/Camera
    â†“ [Raw Image File]
UCrop
    â†“ [Cropped Bitmap]
MainActivity
    â†“ [Bitmap objects: t1Image, t2Image]
ModicAnalyzer
    â†“
    â”œâ”€â†’ LocalModelAnalyzer (Offline)
    â”‚      â†“ [Convert to ByteBuffer]
    â”‚      â†“ [Resize: 224Ã—224]
    â”‚      â†“ [Normalize: (x-127.5)/127.5]
    â”‚      â†“ [ByteOrder.LITTLE_ENDIAN]
    â”‚   TFLite Interpreter
    â”‚      â†“ [Float array output]
    â”‚   Result
    â”‚
    â””â”€â†’ RemoteModelAnalyzer (Online)
           â†“ [Convert to PNG ByteArray]
           â†“ [Base64 Encode]
        HTTP POST /predict
           â†“ [JSON Response]
        Result
```

### 2. **Model Data Flow**

```
Server (modic.onrender.com)
    â†“
    â”œâ”€ /model_info â†’ Hash, Version, Size
    â”‚
    â””â”€ /get_global_model â†’ TFLite model binary
         â†“ [Download stream]
      ModelUpdateManager
         â†“ [Save to internal storage]
      modic_model_offline.tflite
         â†“ [Load into memory]
      ByteBuffer (memory-mapped)
         â†“ [Initialize]
      TFLite Interpreter
         â†“ [Ready for inference]
      LocalModelAnalyzer
```

### 3. **State Management Flow**

```
SharedPreferences (model_prefs)
    â”œâ”€ last_model_hash: "a1b2c3..."
    â”œâ”€ last_check_time: 1699123456789
    â”œâ”€ model_version: "42"
    â””â”€ auto_update_enabled: true

SharedPreferences (modic_analyzer_prefs)
    â”œâ”€ offline_mode_enabled: false
    â””â”€ local_model_downloaded: true

Application State
    â”œâ”€ isOfflineModeEnabled() â†’ UI switches
    â”œâ”€ isLocalModelAvailable() â†’ Feature gates
    â”œâ”€ isAutoUpdateEnabled() â†’ Background jobs
    â””â”€ getAnalysisModeInfo() â†’ Status display
```

---

## Model Management

### 1. **Model Priority and Fallback**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ When LocalModelAnalyzer needs model:                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Try #1: Assets         â”‚
        â”‚ (Bundled in APK)       â”‚
        â”‚ modic_model.tflite     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
            âœ… Found? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚
            âŒ Not found                    â”‚
                 â†“                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Try #2: Internal       â”‚    â”‚ Load model  â”‚
        â”‚ Storage (Downloaded)   â”‚    â”‚ Use for     â”‚
        â”‚ modic_model_offline    â”‚    â”‚ inference   â”‚
        â”‚        .tflite         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
            âœ… Found? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚
            âŒ Not found                    â”‚
                 â†“                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Try #3: Download       â”‚    â”‚ Load model  â”‚
        â”‚ from Server            â”‚    â”‚ Use for     â”‚
        â”‚ /get_global_model      â”‚    â”‚ inference   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
            âœ… Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚
            âŒ Failed                       â”‚
                 â†“                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Error:                 â”‚    â”‚ Save to     â”‚
        â”‚ "Model not available   â”‚    â”‚ internal    â”‚
        â”‚  Please check network" â”‚    â”‚ storage     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚
                                      â”‚ Next time:  â”‚
                                      â”‚ Load from   â”‚
                                      â”‚ Try #2      â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Version Management**

```
Server Model:
  Version: 42
  Hash: a1b2c3d4e5f6...
  
Local Model:
  Version: 41 (stored in SharedPreferences)
  Hash: 9z8y7x6w5v4u... (calculated from file)
  
Update Decision:
  if server_hash != local_hash:
    â†’ Download new model
    â†’ Update version to 42
    â†’ Update hash to a1b2c3d4e5f6...
```

### 3. **Hash Verification Process**

```kotlin
// Server provides hash
serverHash = "a1b2c3d4e5f6..."

// Download model
downloadModel() â†’ temp_file

// Calculate hash of downloaded file
downloadedHash = SHA256(temp_file)
// Result: "a1b2c3d4e5f6..."

// Verify
if (downloadedHash == serverHash) {
    // âœ… Integrity verified
    temp_file.renameTo(modic_model_offline.tflite)
} else {
    // âŒ Corrupted download
    temp_file.delete()
    // Keep old model intact
}
```

---

## Error Handling

### 1. **Network Errors**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Network Request Failed                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Timeout â†’ "Connection timed out"                    â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Show error message                              â”‚
â”‚   â€¢ Suggest offline mode                            â”‚
â”‚   â€¢ Retry button                                    â”‚
â”‚                                                      â”‚
â”‚ No Internet â†’ "No network connection"               â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Detect connectivity                             â”‚
â”‚   â€¢ Auto-switch to offline if model available       â”‚
â”‚   â€¢ Show network icon                               â”‚
â”‚                                                      â”‚
â”‚ Server Error (500) â†’ "Server temporarily down"      â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Retry with exponential backoff                  â”‚
â”‚   â€¢ Fallback to offline mode                        â”‚
â”‚   â€¢ Log for debugging                               â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Model Loading Errors**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Model File Not Found                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Check assets/ â†’ Not found                           â”‚
â”‚   â†“                                                  â”‚
â”‚ Check internal storage â†’ Not found                  â”‚
â”‚   â†“                                                  â”‚
â”‚ Attempt download â†’ Failed                           â”‚
â”‚   â†“                                                  â”‚
â”‚ Result: IOException                                 â”‚
â”‚   "Model file not found. Please check network"      â”‚
â”‚                                                      â”‚
â”‚ UI Response:                                        â”‚
â”‚   â€¢ Show error card                                 â”‚
â”‚   â€¢ Disable offline mode toggle                     â”‚
â”‚   â€¢ Show "Download Model" option                    â”‚
â”‚   â€¢ Guide user to settings                          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **Inference Errors**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inference Failed                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Invalid Image Format                                â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Validate image before preprocessing             â”‚
â”‚   â€¢ Show: "Invalid image format"                    â”‚
â”‚   â€¢ Request re-selection                            â”‚
â”‚                                                      â”‚
â”‚ Model Initialization Failed                         â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Clear interpreter cache                         â”‚
â”‚   â€¢ Retry initialization                            â”‚
â”‚   â€¢ If fails: Download fresh model                  â”‚
â”‚                                                      â”‚
â”‚ Out of Memory                                       â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Scale down images                               â”‚
â”‚   â€¢ Recycle bitmaps                                 â”‚
â”‚   â€¢ Suggest closing other apps                      â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **Update Errors**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Process Errors                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Hash Verification Failed                            â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Delete corrupted download                       â”‚
â”‚   â€¢ Keep existing model intact                      â”‚
â”‚   â€¢ Retry on next cycle                             â”‚
â”‚   â€¢ Log: "Model verification failed"                â”‚
â”‚                                                      â”‚
â”‚ Download Interrupted                                â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Clean up temp files                             â”‚
â”‚   â€¢ Resume on next check                            â”‚
â”‚   â€¢ Don't delete working model                      â”‚
â”‚                                                      â”‚
â”‚ Insufficient Storage                                â”‚
â”‚   â†“                                                  â”‚
â”‚   â€¢ Check available space                           â”‚
â”‚   â€¢ Show: "Not enough storage (need 10MB)"         â”‚
â”‚   â€¢ Skip update                                     â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete User Journey Example

### Scenario: New User with Internet Connection

```
Day 1 - 9:00 AM
â”œâ”€ User installs SpinoCare from Play Store
â”œâ”€ APK includes bundled model in assets/ (8.36 MB)
â”œâ”€ First launch:
â”‚  â”œâ”€ Splash screen
â”‚  â”œâ”€ Permission requests (Storage, Camera)
â”‚  â”œâ”€ initializeAutoUpdates()
â”‚  â”‚  â”œâ”€ Check network: âœ… Connected
â”‚  â”‚  â””â”€ Call /model_info â†’ Server has v42
â”‚  â”œâ”€ Load bundled model (v41) from assets
â”‚  â””â”€ Main screen ready
â”‚
â”œâ”€ Background: Auto-update downloads v42
â”‚  â”œâ”€ Download 8.36 MB
â”‚  â”œâ”€ Verify hash
â”‚  â”œâ”€ Save to internal storage
â”‚  â””â”€ Log: "âœ… Model updated to version 42"
â”‚
â””â”€ User performs analysis:
   â”œâ”€ Select T1 image â†’ Crop â†’ Confirm
   â”œâ”€ Select T2 image â†’ Crop â†’ Confirm
   â”œâ”€ Tap "Analyze Images"
   â”œâ”€ Offline inference (v42)
   â””â”€ Result: "No Modic Changes - 99.97% confidence"

Day 1 - 3:00 PM (6 hours later)
â”œâ”€ Background: Auto-update check
â”œâ”€ Call /model_info â†’ Still v42
â”œâ”€ Hash matches â†’ No update needed
â””â”€ Log: "Model is up to date"

Day 2 - 9:00 AM (Next day)
â”œâ”€ Server updated to v43
â”œâ”€ Background: Auto-update check
â”œâ”€ Call /model_info â†’ Server has v43
â”œâ”€ Hash mismatch â†’ Download v43
â””â”€ User analyses continue with latest model

Day 5 - Airplane Mode
â”œâ”€ No internet connection
â”œâ”€ User performs analysis
â”œâ”€ Offline mode still works (v43 cached)
â””â”€ Auto-update skipped (no network)
```

---

## Key Workflows Summary

| Workflow | Trigger | Duration | Network Required |
|----------|---------|----------|------------------|
| **First Launch** | App install | < 5 sec | Optional |
| **Image Analysis (Offline)** | User action | 1-3 sec | âŒ No |
| **Image Analysis (Online)** | User action | 2-5 sec | âœ… Yes |
| **Auto Update Check** | Every 6 hours | < 2 sec | âœ… Yes |
| **Model Download** | Update available | 30-60 sec | âœ… Yes |
| **Image Cropping** | After selection | User controlled | âŒ No |
| **Settings Change** | User action | Instant | âŒ No |

---

## Performance Characteristics

### Inference Speed
- **Local (TFLite)**: 1-3 seconds
- **Remote (Server)**: 2-5 seconds (depends on network)

### Model Size
- **TFLite Model**: ~8-10 MB
- **APK Size Increase**: ~8-10 MB (if bundled)

### Network Usage
- **Analysis (Online)**: ~2-4 MB per request (2 images)
- **Model Download**: ~8-10 MB per update
- **Version Check**: < 1 KB per check

### Storage Requirements
- **Model File**: 8-10 MB
- **Temp Files**: 8-10 MB (during update)
- **Total**: ~20 MB recommended free space

---

## Conclusion

SpinoCare provides a seamless, intelligent workflow that balances:
- âœ… **Speed**: Local inference for instant results
- âœ… **Accuracy**: Always-updated models via auto-update
- âœ… **Privacy**: Offline-first keeps data on device
- âœ… **Reliability**: Automatic fallbacks and error recovery
- âœ… **User Experience**: Minimal manual intervention

The application is designed to work efficiently in both connected and disconnected scenarios, ensuring medical professionals can rely on it in various clinical environments.
